{% extends "ogrenme/base.html" %}

{% block title %}KiÅŸisel Kontrol Paneli{% endblock %}

{% block content %}

<style>
    /* BoyutlarÄ± kullanÄ±cÄ± tarafÄ±ndan ayarlanabilir yapmak iÃ§in temel CSS */
    .resizable-panel {
        height: 80vh; /* Ekran yÃ¼ksekliÄŸinin %80'i */
        overflow-y: hidden; 
        display: flex;
        flex-direction: column;
        border: 1px solid #ccc;
        border-radius: 8px;
    }

    .chat-body {
        flex-grow: 1; 
        overflow-y: auto;
        padding: 15px;
        display: flex; 
        flex-direction: column; /* MesajlarÄ± eskiden yeniye sÄ±ralar */
    }

    /* KaydÄ±rma Ã§ubuÄŸunu gizle (isteÄŸe baÄŸlÄ±) */
    .chat-body::-webkit-scrollbar { display: none; } 
    .task-list-group { flex-grow: 1; overflow-y: auto; }
</style>

<h1 class="mb-4 text-center text-primary">Merhaba, {{ user.username }}!</h1>

<span style="color: red; font-weight: bold; margin-left: 15px; border: 1px dashed red; padding: 3px;">
    ArkadaÅŸ Kodunuz: {{ kullanici_arkadas_kodu }}
</span>
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endfor %}
{% endif %}

<div class="row g-3">
    
    <div class="col-md-4">
        <div class="card shadow resizable-panel">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">ğŸ§  Yapay Zeka Chat (Serbest)</h5>
            </div>
            
            <div class="chat-body" id="serbest-chat-body">
                {% for chat in serbest_chat_gecmisi %}
                    <div class="alert alert-primary mb-2 ms-5 py-2">
                        <small class="text-muted d-block">{{ user.username }}</small>
                        {{ chat.kullanici_mesaji|linebreaksbr }}
                    </div>
                    <div class="alert alert-secondary mb-2 me-5 py-2">
                        <small class="text-muted d-block">AI</small>
                        {{ chat.ai_cevabi|linebreaksbr }}
                    </div>
                {% empty %}
                    <p class="text-center text-muted mt-auto">Sohbet geÃ§miÅŸiniz boÅŸ. Bir soruyla baÅŸlayÄ±n!</p>
                {% endfor %}
            </div>

            <div class="card-footer bg-light p-2">
                <div class="text-center mb-2">
                    <a href="{% url 'yeni_sohbet_baslat' %}" class="btn btn-sm btn-outline-secondary w-100">
                        Yeni Sohbet BaÅŸlat
                    </a>
                </div>
                
                <form method="POST" action="{% url 'serbest_chat' %}" class="d-flex">
                    {% csrf_token %}
                    <input 
                        type="text" 
                        name="mesaj" 
                        class="form-control form-control-sm me-2" 
                        placeholder="MesajÄ±nÄ±zÄ± YazÄ±n..." 
                        required
                    >
                    <button type="submit" class="btn btn-primary btn-sm">GÃ¶nder</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow resizable-panel">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">âœ¨ KiÅŸiselleÅŸtirilmiÅŸ Kaynak Merkezi</h5>
            </div>
        
            <div class="chat-body" id="kaynak-chat-body">
                {% for kaynak in kaynak_merkezi_gecmisi %}
                
                    <div class="alert alert-primary mb-2 ms-5 py-2">
                        <small class="text-muted d-block">{{ user.username }}</small>
                        {{ kaynak.kullanici_mesaji|linebreaksbr }}
                    </div>
                
                    <div class="alert alert-info mb-2 me-5 py-2">
                        <small class="text-muted d-block">AI (Kaynak)</small>
                        {{ kaynak.ai_cevabi|linebreaksbr|safe }} 
                    </div>
                {% empty %}
                    <p class="text-center text-muted mt-auto">HenÃ¼z oluÅŸturulmuÅŸ bir kaynaÄŸÄ±nÄ±z yok. Ayarlardan yeni bir kaynak oluÅŸturun!</p>
                {% endfor %}
            </div>

            <div class="card-footer bg-light p-2">
                <p class="card-text small text-center mb-2">
                    Seviyenize ve sÄ±nÄ±fÄ±nÄ±za uygun Ã¶zel taslaklar ve Ã¶zetler oluÅŸturun.
                </p>
            
                <button type="button" class="btn btn-success w-100" data-toggle="modal" data-target="#KaynakModal">
                    Kaynak OluÅŸturma AyarlarÄ±
                </button>
            </div>
        </div>
    </div>


    <div class="col-md-4">
        <div class="card shadow resizable-panel">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ğŸ“š OdaklanmÄ±ÅŸ Ã‡alÄ±ÅŸma / Sosyal</h5>
            </div>
            <div class="card-body">
                <h6 class="text-primary">Odaklanma</h6>
                <p>Åu anki ilerlemenize gÃ¶re yeni bir soru iÃ§in hemen baÅŸlayÄ±n:</p>
                <a href="{% url 'test_ai' %}" class="btn btn-success w-100 mb-4">Yeni Soru Ã‡Ã¶z (Matematik)</a>
                
                <h6 class="text-danger">Sosyal ve ArkadaÅŸlÄ±k</h6>
                <p class="text-muted small">ArkadaÅŸ eklemek iÃ§in kullanÄ±cÄ± adÄ±nÄ±/kodunu girin.</p>
                
                <form method="POST" action="{% url 'arkadas_ekle' %}"> 
                    <div class="input-group mb-4">
                        {% csrf_token %}
                        <input type="text" class="form-control" name="arkadas_kodu" placeholder="KullanÄ±cÄ± AdÄ±/Kodu Girin" required>
                        <button class="btn btn-outline-secondary" type="submit">Ä°stek GÃ¶nder</button>
                    </div>
                </form>

                <a href="#" class="btn btn-outline-dark w-100 disabled">HÄ±zlÄ± Chat SayfasÄ±na Git (YakÄ±nda)</a>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="KaynakModal" tabindex="-1" role="dialog" aria-labelledby="KaynakModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      
      <form method="POST" action="{% url 'kaynak_uret' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="KaynakModalLabel">ğŸ¯ Kaynak OluÅŸturma DetaylarÄ±</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        
        <div class="modal-body">
          
          <div class="form-group mb-4">
            <label for="konu_adi">Konu AdÄ± (Ã–rn: TÃ¼rev, Periyodik Tablo, Mol KavramÄ±)</label>
            <input type="text" class="form-control" id="konu_adi" name="konu_adi" placeholder="Ã–rneÄŸin: Mutlak DeÄŸer EÅŸitsizlikleri" required>
            <small class="form-text text-muted">Hangi konuda kaynak Ã¼retilmesini istiyorsunuz? (Bu bilgi AI'a gÃ¶nderilecektir.)</small>
          </div>
          
          <div class="form-group">
            <label for="istek_tipi">Hangi KaynaÄŸÄ± OluÅŸturalÄ±m?</label>
            <select class="form-control" id="istek_tipi" name="istek_tipi">
                <option value="Zihin HaritasÄ± TaslaÄŸÄ±">Zihin HaritasÄ± TaslaÄŸÄ± (HiyerarÅŸik Liste)</option>
                <option value="Konu Ã–zeti">Konu Ã–zeti (DetaylÄ± Metin)</option>
                <option value="Kavram TanÄ±mlarÄ±">Kavram TanÄ±mlarÄ± Listesi</option>
            </select>
            <small class="form-text text-muted">Mevcut seviyeniz veritabanÄ±ndan otomatik alÄ±nacaktÄ±r.</small>
          </div>
          
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button>
          <button type="submit" class="btn btn-success">Kaynak OluÅŸtur!</button>
        </div>
      </form>
      
    </div>
  </div>
</div>

<script>
    function scrollChatToBottom(elementId) {
        var element = document.getElementById(elementId);
        if (element) {
            // KaydÄ±rma Ã§ubuÄŸunu en aÅŸaÄŸÄ±ya taÅŸÄ±r
            element.scrollTop = element.scrollHeight;
        }
    }

    // Sayfa yÃ¼klendiÄŸinde her iki chat panelini de aÅŸaÄŸÄ± kaydÄ±r
    document.addEventListener('DOMContentLoaded', function() {
        scrollChatToBottom('serbest-chat-body'); // Serbest Chat
        scrollChatToBottom('kaynak-chat-body'); // Kaynak Merkezi
    });
</script>
{% endblock %}